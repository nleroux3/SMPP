! This subroutine calculates the mass and energy fluxes at the boundaries of the domain
subroutine boundaries
USE Declarations
implicit none 




IF (N.GT.2) THEN



!----------------------------West Boundary(except lower and north cells)--------------------------------
i=1
IF (M.GT.2) THEN  
	IF (beta.NE. 0.) THEN

		!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
		Fpresw(i,2:M-2)=0.
		Fprese(i,2:M-2)=Sx_east(i,2:M-2)*K_east(i,2:M-2)*&
			&(P(i+1,2:M-2)-P(i,2:M-2))/(abs(xv(i+1,2:M-2)-xv(i,2:M-2)))&
			&+Sy_east(i,2:M-2)*K_east(i,2:M-2)*(P(i+1,2:M-2)-P(i,2:M-2))&
			&/(abs(yv(i+1,2:M-2)-yv(i,2:M-2)))                                 
		Fpress(i,2:M-2)=Sy_south(i,2:M-2)*K_south(i,2:M-2)&
			&*(P(i,1:M-3)-P(i,2:M-2))/(abs(yv(i,2:M-2)-yv(i,1:M-3)))&
			&+Sx_south(i,2:M-2)*K_south(i,2:M-2)*(P(i,1:M-3)-P(i,2:M-2))&
			&/(abs(xv(i,2:M-2)-xv(i,1:M-3)))   
		Fpresn(i,2:M-2)=Sy_north(i,2:M-2)*K_north(i,2:M-2)*&
			&(P(i,3:M-1)-P(i,2:M-2))/(abs(yv(i,3:M-1)-yv(i,2:M-2)))&
			&+Sx_north(i,2:M-2)*K_north(i,2:M-2)*(P(i,3:M-1)-P(i,2:M-2))&
			&/(abs(xv(i,3:M-1)-xv(i,2:M-2))) 

		WHERE (abs(Fprese(i,2:M-2)) .LE. 10) 
			Fprese(i,2:M-2)=0.
		END WHERE


		!----------- Mass flux due to GRAVITY FORCE --------------------------------
		Fgravw(i,2:M-2)=0.                     
		Fgrave(i,2:M-2)=-K_east(i,2:M-2)*Sy_east(i,2:M-2)                                       
		Fgravn(i,2:M-2)=K_north(i,2:M-2)*Sy_north(i,2:M-2)                   
		Fgravs(i,2:M-2)=-K_south(i,2:M-2)*Sy_south(i,2:M-2)



		!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
		Fconds(i,2:M-2)=Sy_south(i,2:M-2)*k_eff_south(i,2:M-2)*&
			&(T(i,1:M-3,1)-T(i,2:M-2,1))/(abs(yv(i,2:M-2)-yv(i,1:M-3)))&
			&+Sx_south(i,2:M-2)*k_eff_south(i,2:M-2)*(T(i,1:M-3,1)-T(i,2:M-2,1))&
			&/(abs(xv(i,2:M-2)-xv(i,1:M-3)))
		Fcondn(i,2:M-2)=Sy_south(i,2:M-2)*k_eff_north(i,2:M-2)*&
			&(T(i,3:M-1,1)-T(i,2:M-2,1))/(abs(yv(i,2:M-2)-yv(i,3:M-1)))&
			&+Sx_south(i,2:M-2)*k_eff_north(i,2:M-2)*(T(i,3:M-1,1)-T(i,2:M-2,1))&
			&/(abs(xv(i,2:M-2)-xv(i,3:M-1)))
		Fconde(i,2:M-2)=Sy_east(i,2:M-2)*k_eff_east(i,2:M-2)*&
			&(T(i+1,2:M-2,1)-T(i,2:M-2,1))/(abs(yv(i,2:M-2)-yv(i+1,2:M-2)))&
			&+Sx_east(i,2:M-2)*k_eff_east(i,2:M-2)*(T(i+1,2:M-2,1)-T(i,2:M-2,1))&
			&/(abs(xv(i,2:M-2)-xv(i+1,2:M-2)))
		Fcondw(i,2:M-2)=0.





	ELSE   ! beta=0.

		!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
		Fpresw(i,2:M-2)=0. 
		Fprese(i,2:M-2)=Sx_east(i,2:M-2)*K_east(i,2:M-2)&
			&*(P(i+1,2:M-2)-P(i,2:M-2))/(abs(xv(i+1,2:M-2)-xv(i,2:M-2)))                                
		Fpress(i,2:M-2)=Sy_south(i,2:M-2)*K_south(i,2:M-2)&
			&*(P(i,1:M-3)-P(i,2:M-2))/(abs(yv(i,2:M-2)-yv(i,1:M-3)))  
		Fpresn(i,2:M-2)=Sy_north(i,2:M-2)*K_north(i,2:M-2)&
			&*(P(i,3:M-1)-P(i,2:M-2))/(abs(yv(i,3:M-1)-yv(i,2:M-2))) 
		
		WHERE (abs(Fprese(i,2:M-2)) .LE. 10) 
			Fprese(i,2:M-2)=0.
		END WHERE

				
		!----------- Mass flux due to GRAVITY FORCE --------------------------------
		Fgravw(i,2:M-2)=0.                                 
		Fgrave(i,2:M-2)=-K_east(i,2:M-2)*Sy_east(i,2:M-2)                                       
		Fgravn(i,2:M-2)=K_north(i,2:M-2)*Sy_north(i,2:M-2)                   
		Fgravs(i,2:M-2)=-K_south(i,2:M-2)*Sy_south(i,2:M-2)
                               


		!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   

		!---------- Matrix to Matrix --------------------------
		Fconds(i,2:M-2)=Sy_south(i,2:M-2)*k_eff_south(i,2:M-2)*&
			&(T(i,1:M-3,1)-T(i,2:M-2,1))/(abs(yv(i,2:M-2)-yv(i,1:M-3)))
		Fcondn(i,2:M-2)=Sy_south(i,2:M-2)*k_eff_north(i,2:M-2)*&
			&(T(i,3:M-1,1)-T(i,2:M-2,1))/(abs(yv(i,2:M-2)-yv(i,3:M-1)))
		Fconde(i,2:M-2)=Sx_east(i,2:M-2)*k_eff_east(i,2:M-2)*&
			(T(i+1,2:M-2,1)-T(i,2:M-2,1))/(abs(xv(i,2:M-2)-xv(i+1,2:M-2))) 
		Fcondw(i,2:M-2)=0.


	ENDIF  

ENDIF





!------------------------- Lower left cell  ---------------------------------------------
i=1
IF (M.GT.2) THEN
	j=1    
	IF (beta.NE.0.) THEN

			!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
			Fpresw(i,j)=0.
			Fprese(i,j)=Sx_east(i,j)*K_east(i,j)*(P(i+1,j)-P(i,j))/(abs(xv(i+1,j)-xv(i,j)))&
				&+Sy_east(i,j)*K_east(i,j)*(P(i+1,j)-P(i,j))/(abs(yv(i+1,j)-yv(i,j))) 
			Fpress(i,j)=0.
			Fpresn(i,j)=Sy_north(i,j)*K_north(i,j)*(P(i,j+1)-P(i,j))/(abs(yv(i,j+1)-yv(i,j)))&
				&+Sx_north(i,j)*K_north(i,j)*(P(i,j+1)-P(i,j))/(abs(xv(i,j+1)-xv(i,j))) 

			IF (abs(Fprese(i,j)) .LE. 10) THEN
				Fprese(i,j)=0.
			ENDIF

			!----------- Mass flux due to GRAVITY FORCE --------------------------------
			Fgravw(i,j)=0.                                      
			Fgrave(i,j)=-K_east(i,j)*Sy_east(i,j)                                       
			Fgravn(i,j)=K_north(i,j)*Sy_north(i,j)                       
			Fgravs(i,j)=-K_south(i,j)*Sy_south(i,j)  


			!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   

			!---------- Matrix to Matrix --------------------------
			Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)&
				&+Sx_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(xv(i,j)-(xn(i+1,j)+xn(i,j))*0.5)) 
			Fcondn(i,j)=Sy_south(i,j)*k_eff_north(i,j)*(T(i,j+1,1)-T(i,j,1))/(abs(yv(i,j)-yv(i,j+1)))&
				&+Sx_south(i,j)*k_eff_north(i,j)*(T(i,j+1,1)-T(i,j,1))/(abs(xv(i,j)-xv(i,j+1)))
			Fconde(i,j)=Sy_east(i,j)*k_eff_east(i,j)*(T(i+1,j,1)-T(i,j,1))/(abs(yv(i,j)-yv(i+1,j)))&
				&+Sx_east(i,j)*k_eff_east(i,j)*(T(i+1,j,1)-T(i,j,1))/(abs(xv(i,j)-xv(i+1,j)))
			Fcondw(i,j)=0.

			Fcond(i,j)=Fcondw(i,j)+Fconde(i,j)+Fconds(i,j)+Fcondn(i,j)


	ELSE   ! beta=0


			!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
			Fpresw(i,j)=0.
			Fprese(i,j)=Sx_east(i,j)*K_east(i,j)*(P(i+1,j)-P(i,j))/(abs(xv(i+1,j)-xv(i,j)))   
			Fpress(i,j)=0.
			Fpresn(i,j)=Sy_north(i,j)*K_north(i,j)*(P(i,j+1)-P(i,j))/(abs(yv(i,j+1)-yv(i,j))) 

			IF (abs(Fprese(i,j)) .LE. 10) THEN
				Fprese(i,j)=0.
			ENDIF
                           


			!----------- Mass flux due to GRAVITY FORCE --------------------------------
			Fgravw(i,j)=0.                                      
			Fgrave(i,j)=-K_east(i,j)*Sy_east(i,j)                                       
			Fgravn(i,j)=K_north(i,j)*Sy_north(i,j)                   
			Fgravs(i,j)=-K_south(i,j)*Sy_south(i,j)


			!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
			Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)
			Fcondn(i,j)=Sy_south(i,j)*k_eff_north(i,j)*(T(i,j+1,1)-T(i,j,1))/(abs(yv(i,j)-yv(i,j+1)))
			Fconde(i,j)=Sx_east(i,j)*k_eff_east(i,j)*(T(i+1,j,1)-T(i,j,1))/(abs(xv(i,j)-xv(i+1,j))) 
			Fcondw(i,j)=0.

	ENDIF 
ENDIF




!------------------------Upper left cells   ------------------
i=1
IF (M.GT.2) THEN
	j=M-1    
	IF (beta.NE.0) THEN

			!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
			Fpresw(i,j)=0.
			Fprese(i,j)=Sx_east(i,j)*K_east(i,j)*(P(i+1,j)-P(i,j))/(abs(xv(i+1,j)-xv(i,j)))&
				&+Sy_east(i,j)*K_east(i,j)*(P(i+1,j)-P(i,j))/(abs(yv(i+1,j)-yv(i,j)))                                 
			Fpress(i,j)=Sy_south(i,j)*K_south(i,j)*(P(i,j-1)-P(i,j))/(abs(yv(i,j)-yv(i,j-1)))&
				&+Sx_south(i,j)*K_south(i,j)*(P(i,j-1)-P(i,j))/(abs(xv(i,j)-xv(i,j-1)))   
			Fpresn(i,j)=0.

			IF (abs(Fprese(i,j)) .LE. 10) THEN
				Fprese(i,j)=0.
			ENDIF     

			!----------- Mass flux due to GRAVITY FORCE --------------------------------
			Fgravw(i,j)=0.                                      
			Fgrave(i,j)=-K_east(i,j)*Sy_east(i,j)                                       
			Fgravn(i,j)=(Qin(i)+rain)*Sy_north(i,j)
			Fgravs(i,j)=-K_south(i,j)*Sy_south(i,j)



			!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
			Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(T(i,j-1,1)-T(i,j,1))/(abs(yv(i,j)-yv(i,j-1)))&
				&+Sx_south(i,j)*k_eff_south(i,j)*(T(i,j-1,1)-T(i,j,1))/(abs(xv(i,j)-xv(i,j-1)))
			Fcondn(i,j)=Sy_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)&
				&+Sx_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(xv(i,j)-abs(xn(i,j+1)+xn(i+1,j+1))*0.5))
			Fconde(i,j)=Sy_east(i,j)*k_eff_east(i,j)*(T(i+1,j,1)-T(i,j,1))/(abs(yv(i,j)-yv(i+1,j)))&
				&+Sx_east(i,j)*k_eff_east(i,j)*(T(i+1,j,1)-T(i,j,1))/(abs(xv(i,j)-xv(i+1,j)))
			Fcondw(i,j)=0.

	ELSE   ! beta=0

			!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
			Fpresw(i,j)=0.
			Fprese(i,j)=Sx_east(i,j)*K_east(i,j)*(P(i+1,j)-P(i,j))/(abs(xv(i+1,j)-xv(i,j)))                                
			Fpress(i,j)=Sy_south(i,j)*K_south(i,j)*(P(i,j-1)-P(i,j))/(abs(yv(i,j)-yv(i,j-1)))  
			Fpresn(i,j)=0.

			IF (abs(Fprese(i,j)) .LE. 10) THEN
				Fprese(i,j)=0.
			ENDIF                       



			!----------- Mass flux due to GRAVITY FORCE --------------------------------
			Fgravw(i,j)=0.                                 
			Fgrave(i,j)=-K_east(i,j)*Sy_east(i,j)                                       
			Fgravn(i,j)=(Qin(i)+rain)*Sy_north(i,j)
			Fgravs(i,j)=-K_south(i,j)*Sy_south(i,j)


			!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
			Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(T(i,j-1,1)-T(i,j,1))/(abs(yv(i,j)-yv(i,j-1)))
			Fcondn(i,j)=Sy_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)
			Fconde(i,j)=Sx_east(i,j)*k_eff_east(i,j)*(T(i+1,j,1)-T(i,j,1))/(abs(xv(i,j)-xv(i+1,j))) 
			Fcondw(i,j)=0.

	ENDIF 
ENDIF





!---------------------------South boundary (except left and right cells)---------------------------------
j=1     
IF (M.GT.2) THEN
	IF (beta.NE.0.) THEN

		!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
		Fpresw(2:N-2,j)=Sx_west(2:N-2,j)*K_west(2:N-2,j)*(P(1:N-3,j)-P(2:N-2,j))&
			&/(abs(xv(2:N-2,j)-xv(1:N-3,j)))+Sy_west(2:N-2,j)*K_west(2:N-2,j)&
			&*(P(1:N-3,j)-P(2:N-2,j))/(abs(yv(2:N-2,j)-yv(1:N-3,j))) 
		Fprese(2:N-2,j)=Sx_east(2:N-2,j)*K_east(2:N-2,j)*(P(3:N-1,j)-P(2:N-2,j))&
			&/(abs(xv(3:N-1,j)-xv(2:N-2,j)))+Sy_east(2:N-2,j)*K_east(2:N-2,j)&
			&*(P(3:N-1,j)-P(2:N-2,j))/(abs(yv(3:N-1,j)-yv(2:N-2,j)))                                 
		Fpress(2:N-2,j)=0. 
		Fpresn(2:N-2,j)=Sy_north(2:N-2,j)*K_north(2:N-2,j)*(P(2:N-2,j+1)-P(2:N-2,j))&
			&/(abs(yv(2:N-2,j+1)-yv(2:N-2,j)))+Sx_north(2:N-2,j)*K_north(2:N-2,j)&
			&*(P(2:N-2,j+1)-P(2:N-2,j))/(abs(xv(2:N-2,j+1)-xv(2:N-2,j))) 

		WHERE (abs(Fprese(2:N-2,j)) .LE. 10)
			Fprese(2:N-2,j)=0.
		END WHERE
		WHERE (abs(Fpresw(2:N-2,j)) .LE. 10)
			Fpresw(2:N-2,j)=0.
		END WHERE	

		!----------- Mass flux due to GRAVITY FORCE --------------------------------
		Fgravw(2:N-2,j)=K_west(2:N-2,j)*Sy_west(2:N-2,j)                                       
		Fgrave(2:N-2,j)=-K_east(2:N-2,j)*Sy_east(2:N-2,j)                                       
		Fgravn(2:N-2,j)=K_north(2:N-2,j)*Sy_north(2:N-2,j)                       
		Fgravs(2:N-2,j)=-K_south(2:N-2,j)*Sy_south(2:N-2,j)  
				              

		!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
		Fconds(2:N-2,j)=Sy_south(2:N-2,j)*k_eff_south(2:N-2,j)*(Tground-T(2:N-2,j,1))&
			&/(abs(yn(2:N-2,j+1)-yn(2:N-2,j))*0.5)+Sx_south(2:N-2,j)*k_eff_south(2:N-2,j)*&
			&(Tground-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-(xn(3:N-1,j)+xn(2:N-2,j))*0.5)) 
		Fcondn(2:N-2,j)=Sy_south(2:N-2,j)*k_eff_north(2:N-2,j)*(T(2:N-2,j+1,1)-T(2:N-2,j,1))&
			&/(abs(yv(2:N-2,j)-yv(2:N-2,j+1)))+Sx_south(2:N-2,j)*k_eff_north(2:N-2,j)*&
			&(T(2:N-2,j+1,1)-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-xv(2:N-2,j+1)))
		Fconde(2:N-2,j)=Sy_east(2:N-2,j)*k_eff_east(2:N-2,j)*(T(3:N-1,j,1)-T(2:N-2,j,1))&
			&/(abs(yv(2:N-2,j)-yv(3:N-1,j)))+Sx_east(2:N-2,j)*k_eff_east(2:N-2,j)*&
			&(T(3:N-1,j,1)-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-xv(3:N-1,j)))
		Fcondw(2:N-2,j)=Sy_west(2:N-2,j)*k_eff_west(2:N-2,j)*(T(1:N-3,j,1)-T(2:N-2,j,1))&
			&/(abs(yv(2:N-2,j)-yv(1:N-3,j)))+Sx_west(2:N-2,j)*k_eff_west(2:N-2,j)*&
			&(T(1:N-3,j,1)-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-xv(1:N-3,j)))

	ELSE   ! beta=0

		!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
		Fpresw(2:N-2,j)=Sx_west(2:N-2,j)*K_west(2:N-2,j)*(P(1:N-3,j)-P(2:N-2,j))/(abs(xv(2:N-2,j)-xv(1:N-3,j))) 
		Fprese(2:N-2,j)=Sx_east(2:N-2,j)*K_east(2:N-2,j)*(P(3:N-1,j)-P(2:N-2,j))/(abs(xv(3:N-1,j)-xv(2:N-2,j)))                                
		Fpress(2:N-2,j)=0.
		Fpresn(2:N-2,j)=Sy_north(2:N-2,j)*K_north(2:N-2,j)*(P(2:N-2,j+1)-P(2:N-2,j))/(abs(yv(2:N-2,j+1)-yv(2:N-2,j))) 

		WHERE (abs(Fprese(2:N-2,j)) .LE. 10)
			Fprese(2:N-2,j)=0.
		END WHERE
		WHERE (abs(Fpresw(2:N-2,j)) .LE. 10)
			Fpresw(2:N-2,j)=0.
		END WHERE	


		!----------- Mass flux due to GRAVITY FORCE --------------------------------
		Fgravw(2:N-2,j)=K_west(2:N-2,j)*Sy_west(2:N-2,j)                                       
		Fgrave(2:N-2,j)=-K_east(2:N-2,j)*Sy_east(2:N-2,j)                                       
		Fgravn(2:N-2,j)=K_north(2:N-2,j)*Sy_north(2:N-2,j)                   
		Fgravs(2:N-2,j)=-K_south(2:N-2,j)*Sy_south(2:N-2,j)
				

		!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
		Fconds(2:N-2,j)=Sy_south(2:N-2,j)*k_eff_south(2:N-2,j)*(Tground-T(2:N-2,j,1))/(abs(yn(2:N-2,j+1)-yn(2:N-2,j))*0.5)
		Fcondn(2:N-2,j)=Sy_south(2:N-2,j)*k_eff_north(2:N-2,j)*(T(2:N-2,j+1,1)-T(2:N-2,j,1))/(abs(yv(2:N-2,j)-yv(2:N-2,j+1)))
		Fconde(2:N-2,j)=Sx_east(2:N-2,j)*k_eff_east(2:N-2,j)*(T(3:N-1,j,1)-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-xv(3:N-1,j))) 
		Fcondw(2:N-2,j)=Sx_west(2:N-2,j)*k_eff_west(2:N-2,j)*(T(1:N-3,j,1)-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-xv(1:N-3,j))) 


		
	ENDIF 
ENDIF





!--------------------------------------East Boundary (except upper and lower cells)-----------------------
i=N-1   
IF (M.GT.2) THEN
	IF (beta.NE.0.) THEN

		!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
		Fpresw(i,2:M-2)=Sx_west(i,2:M-2)*K_west(i,2:M-2)*(P(i-1,2:M-2)-P(i,2:M-2))&
			&/(abs(xv(i,2:M-2)-xv(i-1,2:M-2)))+Sy_west(i,2:M-2)*K_west(i,2:M-2)*&
			&(P(i-1,2:M-2)-P(i,2:M-2))/(abs(yv(i,2:M-2)-yv(i-1,2:M-2))) 
		Fprese(i,2:M-2)=0.                                 
		Fpress(i,2:M-2)=Sy_south(i,2:M-2)*K_south(i,2:M-2)*(P(i,1:M-3)-P(i,2:M-2))&
			&/(abs(yv(i,2:M-2)-yv(i,1:M-3)))+Sx_south(i,2:M-2)*K_south(i,2:M-2)*&
			&(P(i,1:M-3)-P(i,2:M-2))/(abs(xv(i,2:M-2)-xv(i,1:M-3)))   
		Fpresn(i,2:M-2)=Sy_north(i,2:M-2)*K_north(i,2:M-2)*(P(i,3:M-1)-P(i,2:M-2))&
			&/(abs(yv(i,3:M-1)-yv(i,2:M-2)))+Sx_north(i,2:M-2)*K_north(i,2:M-2)*&
			&(P(i,3:M-1)-P(i,2:M-2))/(abs(xv(i,3:M-1)-xv(i,2:M-2))) 

		WHERE (abs(Fpresw(i,2:M-2)) .LE. 10) 
			Fpresw(i,2:M-2)=0.
		END WHERE	


		!----------- Mass flux due to GRAVITY FORCE --------------------------------
		Fgravw(i,2:M-2)=K_west(i,2:M-2)*Sy_west(i,2:M-2)                                       
		Fgrave(i,2:M-2)=-K_east(i,2:M-2)*Sy_east(i,2:M-2)                                       
		Fgravn(i,2:M-2)=K_north(i,2:M-2)*Sy_north(i,2:M-2)                   
		Fgravs(i,2:M-2)=-K_south(i,2:M-2)*Sy_south(i,2:M-2)


		!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   

		!---------- Matrix to Matrix --------------------------
		Fconds(i,2:M-2)=Sy_south(i,2:M-2)*k_eff_south(i,2:M-2)*(T(i,1:M-3,1)-T(i,2:M-2,1))&
			&/(abs(yv(i,2:M-2)-yv(i,1:M-3)))+Sx_south(i,2:M-2)*k_eff_south(i,2:M-2)*&
			&(T(i,1:M-3,1)-T(i,2:M-2,1))/(abs(xv(i,2:M-2)-xv(i,1:M-3)))
		Fcondn(i,2:M-2)=Sy_south(i,2:M-2)*k_eff_north(i,2:M-2)*(T(i,3:M-1,1)-T(i,2:M-2,1))&
			&/(abs(yv(i,2:M-2)-yv(i,3:M-1)))+Sx_south(i,2:M-2)*k_eff_north(i,2:M-2)*&
			&(T(i,3:M-1,1)-T(i,2:M-2,1))/(abs(xv(i,2:M-2)-xv(i,3:M-1)))
		Fconde(i,2:M-2)=0.
		Fcondw(i,2:M-2)=Sy_west(i,2:M-2)*k_eff_west(i,2:M-2)*(T(i-1,2:M-2,1)-T(i,2:M-2,1))&
			&/(abs(yv(i,2:M-2)-yv(i-1,2:M-2)))+Sx_west(i,2:M-2)*k_eff_west(i,2:M-2)*&
			&(T(i-1,2:M-2,1)-T(i,2:M-2,1))/(abs(xv(i,2:M-2)-xv(i-1,2:M-2)))


	ELSE   ! beta=0


		!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
		Fpresw(i,2:M-2)=Sx_west(i,2:M-2)*K_west(i,2:M-2)*(P(i-1,2:M-2)-P(i,2:M-2))&
			&/(abs(xv(i,2:M-2)-xv(i-1,2:M-2))) 
		Fprese(i,2:M-2)=0.                 
		Fpress(i,2:M-2)=Sy_south(i,2:M-2)*K_south(i,2:M-2)*(P(i,1:M-3)-P(i,2:M-2))&
			&/(abs(yv(i,2:M-2)-yv(i,1:M-3)))  
		Fpresn(i,2:M-2)=Sy_north(i,2:M-2)*K_north(i,2:M-2)*(P(i,3:M-1)-P(i,2:M-2))&
			&/(abs(yv(i,2:M-2)-yv(i,3:M-1))) 
				

		WHERE (abs(Fpresw(i,2:M-2)) .LE. 10)
			Fpresw(i,2:M-2)=0.
		END WHERE	                             

				

		!----------- Mass flux due to GRAVITY FORCE --------------------------------
		Fgravw(i,2:M-2)=K_west(i,2:M-2)*Sy_west(i,2:M-2)                                       
		Fgrave(i,2:M-2)=-K_east(i,2:M-2)*Sy_east(i,2:M-2)                                       
		Fgravn(i,2:M-2)=K_north(i,2:M-2)*Sy_north(i,2:M-2)                   
		Fgravs(i,2:M-2)=-K_south(i,2:M-2)*Sy_south(i,2:M-2)



		!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
		Fconds(i,2:M-2)=Sy_south(i,2:M-2)*k_eff_south(i,2:M-2)*(T(i,1:M-3,1)-T(i,2:M-2,1))&
			&/(abs(yv(i,2:M-2)-yv(i,1:M-3)))
		Fcondn(i,2:M-2)=Sy_south(i,2:M-2)*k_eff_north(i,2:M-2)*(T(i,3:M-1,1)-T(i,2:M-2,1))&
			&/(abs(yv(i,2:M-2)-yv(i,3:M-1)))
		Fconde(i,2:M-2)=0.
		Fcondw(i,2:M-2)=Sx_west(i,2:M-2)*k_eff_west(i,2:M-2)*(T(i-1,2:M-2,1)-T(i,2:M-2,1))&
			&/(abs(xv(i,2:M-2)-xv(i-1,2:M-2)))

	
	ENDIF
ENDIF





!-----------------------------------------   Lower right cell   -------------------------------------------

i=N-1  
IF (M.GT.2) THEN
	j=1
	IF (beta.NE.0) THEN

			!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
			Fpresw(i,j)=Sx_west(i,j)*K_west(i,j)*(P(i-1,j)-P(i,j))/(abs(xv(i,j)-xv(i-1,j)))&
				&+Sy_west(i,j)*K_west(i,j)*(P(i-1,j)-P(i,j))/(abs(yv(i,j)-yv(i-1,j))) 
			Fprese(i,j)=0.                             
			Fpress(i,j)=0.
			Fpresn(i,j)=Sy_north(i,j)*K_north(i,j)*(P(i,j+1)-P(i,j))/(abs(yv(i,j+1)-yv(i,j)))&
				&+Sx_north(i,j)*K_north(i,j)*(P(i,j+1)-P(i,j))/(abs(xv(i,j+1)-xv(i,j))) 

			IF (abs(Fpresw(i,j)) .LE. 10) THEN
				Fpresw(i,j)=0.
			ENDIF	

			!----------- Mass flux due to GRAVITY FORCE --------------------------------
			Fgravw(i,j)=K_west(i,j)*Sy_west(i,j)                                       
			Fgrave(i,j)=-K_east(i,j)*Sy_east(i,j)                                       
			Fgravn(i,j)=K_north(i,j)*Sy_north(i,j)                       
			Fgravs(i,j)=-K_south(i,j)*Sy_south(i,j)  
			

			!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
			Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)&
				&+Sx_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(xv(i,j)-(xn(i+1,j)+xn(i,j))*0.5)) 
			Fcondn(i,j)=Sy_south(i,j)*k_eff_north(i,j)*(T(i,j+1,1)-T(i,j,1))/(abs(yv(i,j)-yv(i,j+1)))&
				&+Sx_south(i,j)*k_eff_north(i,j)*(T(i,j+1,1)-T(i,j,1))/(abs(xv(i,j)-xv(i,j+1)))
			Fconde(i,j)=0.
			Fcondw(i,j)=Sy_west(i,j)*k_eff_west(i,j)*(T(i-1,j,1)-T(i,j,1))/(abs(yv(i,j)-yv(i-1,j)))&
				&+Sx_west(i,j)*k_eff_west(i,j)*(T(i-1,j,1)-T(i,j,1))/(abs(xv(i,j)-xv(i-1,j)))


	ELSE   ! beta=0

			!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
			Fpresw(i,j)=Sx_west(i,j)*K_west(i,j)*(P(i-1,j)-P(i,j))/(abs(xv(i,j)-xv(i-1,j))) 
			Fprese(i,j)=0.                               
			Fpress(i,j)=0.
			Fpresn(i,j)=Sy_north(i,j)*K_north(i,j)*(P(i,j+1)-P(i,j))/(abs(yv(i,j+1)-yv(i,j))) 
				

			IF (abs(Fpresw(i,j)) .LE. 10) THEN
				Fpresw(i,j)=0.
			ENDIF	                            


			!----------- Mass flux due to GRAVITY FORCE --------------------------------
			Fgravw(i,j)=K_west(i,j)*Sy_west(i,j)                                       
			Fgrave(i,j)=-K_east(i,j)*Sy_east(i,j)                                       
			Fgravn(i,j)=K_north(i,j)*Sy_north(i,j)                   
			Fgravs(i,j)=-K_south(i,j)*Sy_south(i,j)

			!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
			Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5) 
			Fcondn(i,j)=Sy_south(i,j)*k_eff_north(i,j)*(T(i,j+1,1)-T(i,j,1))/(abs(yv(i,j)-yv(i,j+1)))
			Fconde(i,j)=0.
			Fcondw(i,j)=Sx_west(i,j)*k_eff_west(i,j)*(T(i-1,j,1)-T(i,j,1))/(abs(xv(i,j)-xv(i-1,j))) 


	ENDIF 
ENDIF



!---------------------------------North Boundary (except west and east cells)---------------------------------------

IF (M.GT.2) THEN
	j=M-1 
	IF (beta.NE.0) THEN

		!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------1
		Fpresw(2:N-2,j)=Sx_west(2:N-2,j)*K_west(2:N-2,j)*(P(1:N-3,j)-P(2:N-2,j))/(abs(xv(2:N-2,j)-xv(1:N-3,j)))&
			&+Sy_west(2:N-2,j)*K_west(2:N-2,j)*(P(1:N-3,j)-P(2:N-2,j))/(abs(yv(2:N-2,j)-yv(1:N-3,j))) 
		Fprese(2:N-2,j)=Sx_east(2:N-2,j)*K_east(2:N-2,j)*(P(3:N-1,j)-P(2:N-2,j))/(abs(xv(3:N-1,j)-xv(2:N-2,j)))&
			&+Sy_east(2:N-2,j)*K_east(2:N-2,j)*(P(3:N-1,j)-P(2:N-2,j))/(abs(yv(3:N-1,j)-yv(2:N-2,j)))                                 
		Fpress(2:N-2,j)=Sy_south(2:N-2,j)*K_south(2:N-2,j)*(P(2:N-2,j-1)-P(2:N-2,j))/(abs(yv(2:N-2,j)-yv(2:N-2,j-1)))&
			&+Sx_south(2:N-2,j)*K_south(2:N-2,j)*(P(2:N-2,j-1)-P(2:N-2,j))/(abs(xv(2:N-2,j)-xv(2:N-2,j-1)))   
		Fpresn(2:N-2,j)=0.


		WHERE (abs(Fprese(2:N-2,j)) .LE. 10) 
			Fprese(2:N-2,j)=0.
		END WHERE
		WHERE(abs(Fpresw(2:N-2,j)) .LE. 10) 
			Fpresw(2:N-2,j)=0.
		END WHERE	


		!----------- Mass flux due to GRAVITY FORCE --------------------------------
		Fgravw(2:N-2,j)=K_west(2:N-2,j)*Sy_west(2:N-2,j)                                       
		Fgrave(2:N-2,j)=-K_east(2:N-2,j)*Sy_east(2:N-2,j)                                       
		Fgravn(2:N-2,j)=(Qin(2:N-2)+rain)*Sy_north(2:N-2,j)
		Fgravs(2:N-2,j)=-K_south(2:N-2,j)*Sy_south(2:N-2,j)
		

		!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
		Fconds(2:N-2,j)=Sy_south(2:N-2,j)*k_eff_south(2:N-2,j)*(T(2:N-2,j-1,1)-T(2:N-2,j,1))/(abs(yv(2:N-2,j)-yv(2:N-2,j-1)))&
			&+Sx_south(2:N-2,j)*k_eff_south(2:N-2,j)*(T(2:N-2,j-1,1)-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-xv(2:N-2,j-1)))
		Fcondn(2:N-2,j)=Sy_north(2:N-2,j)*k_eff_north(2:N-2,j)*(Tss(2:N-2)-T(2:N-2,j,1))/(abs(yn(2:N-2,j+1)-yn(2:N-2,j))*0.5)&
			&+Sx_north(2:N-2,j)*k_eff_north(2:N-2,j)*(Tss(2:N-2)-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-abs(xn(2:N-2,j+1)+xn(3:N-1,j+1))*0.5)) 
		Fconde(2:N-2,j)=Sy_east(2:N-2,j)*k_eff_east(2:N-2,j)*(T(3:N-1,j,1)-T(2:N-2,j,1))/(abs(yv(2:N-2,j)-yv(3:N-1,j)))&
			&+Sx_east(2:N-2,j)*k_eff_east(2:N-2,j)*(T(3:N-1,j,1)-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-xv(3:N-1,j)))
		Fcondw(2:N-2,j)=Sy_west(2:N-2,j)*k_eff_west(2:N-2,j)*(T(1:N-3,j,1)-T(2:N-2,j,1))/(abs(yv(2:N-2,j)-yv(1:N-3,j)))&
			&+Sx_west(2:N-2,j)*k_eff_west(2:N-2,j)*(T(1:N-3,j,1)-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-xv(1:N-3,j)))


	
	ELSE   ! beta=0

		!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
		Fpresw(2:N-2,j)=Sx_west(2:N-2,j)*K_west(2:N-2,j)*(P(1:N-3,j)-P(2:N-2,j))/(abs(xv(2:N-2,j)-xv(1:N-3,j))) 
		Fprese(2:N-2,j)=Sx_east(2:N-2,j)*K_east(2:N-2,j)*(P(3:N-1,j)-P(2:N-2,j))/(abs(xv(3:N-1,j)-xv(2:N-2,j)))                                
		Fpress(2:N-2,j)=Sy_south(2:N-2,j)*K_south(2:N-2,j)*(P(2:N-2,j-1)-P(2:N-2,j))/(abs(yv(2:N-2,j)-yv(2:N-2,j-1)))  
		Fpresn(2:N-2,j)=0. 


		WHERE (abs(Fprese(2:N-2,j)) .LE. 10) 
			Fprese(2:N-2,j)=0.
		END WHERE
		WHERE (abs(Fpresw(2:N-2,j)) .LE. 10)
			Fpresw(2:N-2,j)=0.
		END WHERE	

		!----------- Mass flux due to GRAVITY FORCE --------------------------------
		Fgravw(2:N-2,j)=K_west(2:N-2,j)*Sy_west(2:N-2,j)                                       
		Fgrave(2:N-2,j)=-K_east(2:N-2,j)*Sy_east(2:N-2,j)                                       
		Fgravn(2:N-2,j)=(Qin(2:N-2)+rain)*Sy_north(2:N-2,j)
		Fgravs(2:N-2,j)=-K_south(2:N-2,j)*Sy_south(2:N-2,j)
	

		!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
		Fconds(2:N-2,j)=Sy_south(2:N-2,j)*k_eff_south(2:N-2,j)*(T(2:N-2,j-1,1)-T(2:N-2,j,1))/(abs(yv(2:N-2,j)-yv(2:N-2,j-1)))
		Fcondn(2:N-2,j)=Sy_north(2:N-2,j)*k_eff_north(2:N-2,j)*(Tss(2:N-2)-T(2:N-2,j,1))/(abs(yn(2:N-2,j+1)-yn(2:N-2,j))*0.5)
		Fconde(2:N-2,j)=Sx_east(2:N-2,j)*k_eff_east(2:N-2,j)*(T(3:N-1,j,1)-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-xv(3:N-1,j))) 
		Fcondw(2:N-2,j)=Sx_west(2:N-2,j)*k_eff_west(2:N-2,j)*(T(1:N-3,j,1)-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-xv(1:N-3,j))) 


	ENDIF 
ENDIF   

 





!----------------------------------Upper right cell-------------------------------------  
i=N-1
IF (M.GT.2) THEN
	j=M-1 
	IF (beta.NE.0) THEN

		!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
		Fpresw(i,j)=Sx_west(i,j)*K_west(i,j)*(P(i-1,j)-P(i,j))/(abs(xv(i,j)-xv(i-1,j)))&
			&+Sy_west(i,j)*K_west(i,j)*(P(i-1,j)-P(i,j))/(abs(yv(i,j)-yv(i-1,j))) 
		Fprese(i,j)=0.                            
		Fpress(i,j)=Sy_south(i,j)*K_south(i,j)*(P(i,j-1)-P(i,j))/(abs(yv(i,j)-yv(i,j-1)))&
			&+Sx_south(i,j)*K_south(i,j)*(P(i,j-1)-P(i,j))/(abs(xv(i,j)-xv(i,j-1)))   
		Fpresn(i,j)=0.


		IF (abs(Fpresw(i,j)) .LE. 10) THEN
			Fpresw(i,j)=0.
		ENDIF	                             


		!----------- Mass flux due to GRAVITY FORCE --------------------------------
		Fgravw(i,j)=K_west(i,j)*Sy_west(i,j)                                       
		Fgrave(i,j)=-K_east(i,j)*Sy_east(i,j)                                       
		Fgravn(i,j)=(Qin(i)+rain)*Sy_north(i,j)
		Fgravs(i,j)=-K_south(i,j)*Sy_south(i,j)


		!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
		Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(T(i,j-1,1)-T(i,j,1))/(abs(yv(i,j)-yv(i,j-1)))&
			&+Sx_south(i,j)*k_eff_south(i,j)*(T(i,j-1,1)-T(i,j,1))/(abs(xv(i,j)-xv(i,j-1)))
		Fcondn(i,j)=Sy_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)&
			&+Sx_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(xv(i,j)-abs(xn(i,j+1)+xn(i+1,j+1))*0.5))
		Fconde(i,j)=0.
		Fcondw(i,j)=Sy_west(i,j)*k_eff_west(i,j)*(T(i-1,j,1)-T(i,j,1))/(abs(yv(i,j)-yv(i-1,j)))&
			&+Sx_west(i,j)*k_eff_west(i,j)*(T(i-1,j,1)-T(i,j,1))/(abs(xv(i,j)-xv(i-1,j)))


	ELSE   ! beta=0

		!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
		Fpresw(i,j)=Sx_west(i,j)*K_west(i,j)*(P(i-1,j)-P(i,j))/(abs(xv(i,j)-xv(i-1,j))) 
		Fprese(i,j)=0.                               
		Fpress(i,j)=Sy_south(i,j)*K_south(i,j)*(P(i,j-1)-P(i,j))/(abs(yv(i,j)-yv(i,j-1)))  
		Fpresn(i,j)=0.
				

		IF (abs(Fpresw(i,j)) .LE. 10) THEN
			Fpresw(i,j)=0.
		ENDIF	                             


		!----------- Mass flux due to GRAVITY FORCE --------------------------------
		Fgravw(i,j)=K_west(i,j)*Sy_west(i,j)                                       
		Fgrave(i,j)=-K_east(i,j)*Sy_east(i,j)                                       
		Fgravn(i,j)=(Qin(i)+rain)*Sy_north(i,j)                         
		Fgravs(i,j)=-K_south(i,j)*Sy_south(i,j)
    

		!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
		Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(T(i,j-1,1)-T(i,j,1))/(abs(yv(i,j)-yv(i,j-1)))
		Fcondn(i,j)=Sy_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)
		Fconde(i,j)=0.
		Fcondw(i,j)=Sx_west(i,j)*k_eff_west(i,j)*(T(i-1,j,1)-T(i,j,1))/(abs(xv(i,j)-xv(i-1,j))) 

	ENDIF 
ENDIF 




!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Only one layer
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!





!------------------------ Left cell  ---------------------------------------------
IF (M.EQ.2) THEN
	j=1
	i=1

	!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
	IF (BETA.NE.0) THEN
		Fpresw(i,j)=0.                              
		Fprese(i,j)=Sx_east(i,j)*K_east(i,j)*(P(i+1,j)-P(i,j))/(abs(xv(i+1,j)-xv(i,j)))&
			&+Sy_east(i,j)*K_east(i,j)*(P(i+1,j)-P(i,j))/(abs(yv(i+1,j)-yv(i,j)))                                 
		Fpress(i,j)=0.  
		Fpresn(i,j)=0.
	ELSE
		Fpresw(i,j)=0.                               
		Fprese(i,j)=Sx_east(i,j)*K_east(i,j)*(P(i+1,j)-P(i,j))/(abs(xv(i+1,j)-xv(i,j)))                               
		Fpress(i,j)=0.  
		Fpresn(i,j)=0.  
	ENDIF

	IF (abs(Fprese(i,j)) .LE. 10) THEN
		Fprese(i,j)=0.
	ENDIF


	!----------- Mass flux due to GRAVITY FORCE --------------------------------
	Fgravw(i,j)=0.                                      
	Fgrave(i,j)=-K_east(i,j)*Sy_east(i,j)                              
	Fgravn(i,j)=(Qin(i)+rain)*Sy_north(i,j)                 
	Fgravs(i,j)=-K_south(i,j)*Sy_south(i,j) 




	!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
	IF (BETA.NE.0) THEN
		Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)&
			&+Sx_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(xv(i,j)-(xn(i+1,j)+xn(i,j))*0.5))        
		Fcondn(i,j)=Sy_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)&
			&+Sx_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(xv(i,j)-abs(xn(i,j+1)+xn(i+1,j+1))*0.5))
		Fconde(i,j)=Sy_east(i,j)*k_eff_east(i,j)*(T(i+1,j,1)-T(i,j,1))/(abs(yv(i,j)-yv(i+1,j)))&
			&+Sx_east(i,j)*k_eff_east(i,j)*(T(i+1,j,1)-T(i,j,1))/(abs(xv(i,j)-xv(i+1,j)))
		Fcondw(i,j)=0.

	ELSE
		Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(yv(i,j)))   
		Fcondn(i,j)=Sy_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)
		Fconde(i,j)=Sx_east(i,j)*k_eff_east(i,j)*(T(i+1,j,1)-T(i,j,1))/(abs(xv(i,j)-xv(i+1,j)))
		Fcondw(i,j)=0.
	ENDIF



!--------------------------- Middle cells ---------------------------------    
	
	j=1
	!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
	IF (BETA.NE.0) THEN
		Fpresw(2:N-2,j)=Sx_west(2:N-2,j)*K_west(2:N-2,j)*(P(1:N-3,j)-P(2:N-2,j))/(abs(xv(2:N-2,j)-xv(1:N-3,j)))&
			&+Sy_west(2:N-2,j)*K_west(2:N-2,j)*(P(1:N-3,j)-P(2:N-2,j))/(abs(yv(2:N-2,j)-yv(1:N-3,j)))                               
		Fprese(2:N-2,j)=Sx_east(2:N-2,j)*K_east(2:N-2,j)*(P(3:N-1,j)-P(2:N-2,j))/(abs(xv(3:N-1,j)-xv(2:N-2,j)))&
			&+Sy_east(2:N-2,j)*K_east(2:N-2,j)*(P(3:N-1,j)-P(2:N-2,j))/(abs(yv(3:N-1,j)-yv(2:N-2,j)))                                 
		Fpress(2:N-2,j)=0.   
		Fpresn(2:N-2,j)=0.   
	ELSE
		Fpresw(2:N-2,j)=Sx_west(2:N-2,j)*K_west(2:N-2,j)*(P(1:N-3,j)-P(2:N-2,j))/(abs(xv(2:N-2,j)-xv(1:N-3,j)))                               
		Fprese(2:N-2,j)=Sx_east(2:N-2,j)*K_east(2:N-2,j)*(P(3:N-1,j)-P(2:N-2,j))/(abs(xv(3:N-1,j)-xv(2:N-2,j)))                                 
		Fpress(2:N-2,j)=0.  
		Fpresn(2:N-2,j)=0.  
	ENDIF


	WHERE (abs(Fprese(2:N-2,j)) .LE. 10) 
		Fprese(2:N-2,j)=0.
	END WHERE
	WHERE (abs(Fpresw(2:N-2,j)) .LE. 10) 
		Fpresw(2:N-2,j)=0.
	END WHERE

	!----------- Mass flux due to GRAVITY FORCE --------------------------------
	Fgravw(2:N-2,j)=K_west(2:N-2,j)*Sy_west(2:N-2,j)                                    
	Fgrave(2:N-2,j)=-K_east(2:N-2,j)*Sy_east(2:N-2,j)                             
	Fgravn(2:N-2,j)=(Qin(2:N-2)+rain)*Sy_north(2:N-2,j)                
	Fgravs(2:N-2,j)=-K_south(2:N-2,j)*Sy_south(2:N-2,j) 
	


	!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
	IF (BETA.NE.0) THEN
		Fconds(2:N-2,j)=Sy_south(2:N-2,j)*k_eff_south(2:N-2,j)*(Tground-T(2:N-2,j,1))/(abs(yn(2:N-2,j+1)-yn(2:N-2,j))*0.5)&
			&+Sx_south(2:N-2,j)*k_eff_south(2:N-2,j)*(Tground-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-(xn(3:N-1,j)+xn(2:N-2,j))*0.5)) 
		Fcondn(2:N-2,j)=Sy_north(2:N-2,j)*k_eff_north(2:N-2,j)*(Tss(i)-T(2:N-2,j,1))/(abs(yn(2:N-2,j+1)-yn(2:N-2,j))*0.5)&
			&+Sx_north(2:N-2,j)*k_eff_north(2:N-2,j)*(Tss(2:N-2)-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-abs(xn(2:N-2,j+1)+xn(3:N-1,j+1))*0.5))
		Fconde(2:N-2,j)=Sy_east(2:N-2,j)*k_eff_east(2:N-2,j)*(T(3:N-1,j,1)-T(2:N-2,j,1))/(abs(yv(2:N-2,j)-yv(3:N-1,j)))&
			&+Sx_east(2:N-2,j)*k_eff_east(2:N-2,j)*(T(3:N-1,j,1)-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-xv(3:N-1,j)))
		Fcondw(2:N-2,j)=Sy_west(2:N-2,j)*k_eff_west(2:N-2,j)*(T(1:N-3,j,1)-T(2:N-2,j,1))/(abs(yv(2:N-2,j)-yv(1:N-3,j)))&
			&+Sx_west(2:N-2,j)*k_eff_west(2:N-2,j)*(T(1:N-3,j,1)-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-xv(1:N-3,j)))
	ELSE
		Fconds(2:N-2,j)=Sy_south(2:N-2,j)*k_eff_south(2:N-2,j)*(Tground-T(2:N-2,j,1))/(abs(yv(2:N-2,j)*0.5))
		Fcondn(2:N-2,j)=Sy_north(2:N-2,j)*k_eff_north(2:N-2,j)*(Tss(2:N-2)-T(2:N-2,j,1))/(abs(yn(2:N-2,j+1)-yn(2:N-2,j))*0.5)
		Fconde(2:N-2,j)=Sx_east(2:N-2,j)*k_eff_east(2:N-2,j)*(T(3:N-1,j,1)-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-xv(3:N-1,j)))
		Fcondw(2:N-2,j)=Sx_west(2:N-2,j)*k_eff_west(2:N-2,j)*(T(1:N-3,j,1)-T(2:N-2,j,1))/(abs(xv(2:N-2,j)-xv(1:N-3,j)))
	ENDIF  


!--------------------------------------East Boundary -----------------------
	i=N-1   
	j=1
	!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
	IF (BETA.NE.0.) THEN
		Fpresw(i,j)=Sx_west(i,j)*K_west(i,j)*(P(i-1,j)-P(i,j))/(abs(xv(i,j)-xv(i-1,j)))&
			&+Sy_west(i,j)*K_west(i,j)*(P(i-1,j)-P(i,j))/(abs(yv(i,j)-yv(i-1,j)))                               
		Fprese(i,j)=0.                                 
		Fpress(i,j)=0.
		Fpresn(i,j)=0.   
	ELSE
		Fpresw(i,j)=Sx_west(i,j)*K_west(i,j)*(P(i-1,j)-P(i,j))/(abs(xv(i,j)-xv(i-1,j)))                               
		Fprese(i,j)=0.                                 
		Fpress(i,j)=0.
		Fpresn(i,j)=0.  
	ENDIF


	IF (abs(Fpresw(i,j)) .LE. 10) THEN
		Fpresw(i,j)=0.
	ENDIF

	!----------- Mass flux due to GRAVITY FORCE --------------------------------
	Fgravw(i,j)=K_west(i,j)*Sy_west(i,j)                                    
	Fgrave(i,j)=-K_east(i,j)*Sy_east(i,j)                              
	Fgravn(i,j)=(Qin(i)+rain)*Sy_north(i,j)               
	Fgravs(i,j)=-K_south(i,j)*Sy_south(i,j) 


	!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
	IF (BETA.NE.0.) THEN
		Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)&
			&+Sx_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(xv(i,j)-(xn(i+1,j)+xn(i,j))*0.5)) 
		Fcondn(i,j)=Sy_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)&
			&+Sx_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(xv(i,j)-abs(xn(i,j+1)+xn(i+1,j+1))*0.5))
		Fconde(i,j)=0.
		Fcondw(i,j)=Sy_west(i,j)*k_eff_west(i,j)*(T(i-1,j,1)-T(i,j,1))/(abs(yv(i,j)-yv(i-1,j)))&
			&+Sx_west(i,j)*k_eff_west(i,j)*(T(i-1,j,1)-T(i,j,1))/(abs(xv(i,j)-xv(i-1,j)))
	ELSE
		Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(yv(i,j)*0.5))
		Fcondn(i,j)=Sy_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)
		Fconde(i,j)=0.
		Fcondw(i,j)=Sx_west(i,j)*k_eff_west(i,j)*(T(i-1,j,1)-T(i,j,1))/(abs(xv(i,j)-xv(i-1,j)))
	ENDIF  

ENDIF



ELSE ! IF N.EQ.2
    
	i=1
	
	IF (M.GT.2) THEN

		!!!!!!!!!!!!! UPPER CELL !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

		j=M-1

		!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
		Fpresw(i,j)=0.                             
		Fprese(i,j)=0.        
		IF (BETA.NE.0) THEN
			Fpress(i,j)=Sy_south(i,j)*K_south(i,j)*(P(i,j-1)-P(i,j))/(abs(yv(i,j)-yv(i,j-1)))&
				&+Sx_south(i,j)*K_south(i,j)*(P(i,j-1)-P(i,j))/(abs(xv(i,j)-xv(i,j-1)))      
		ELSE
			Fpress(i,j)=Sy_south(i,j)*K_south(i,j)*(P(i,j-1)-P(i,j))/(abs(yv(i,j)-yv(i,j-1)))				 
		ENDIF
		Fpresn(i,j)=0.   



		!----------- Mass flux due to GRAVITY FORCE --------------------------------
		Fgravw(i,j)=0.                                  
		Fgrave(i,j)=-K_east(i,j)*Sy_east(i,j)                             
		Fgravn(i,j)=rain*(Sy_north(i,j)**2.+Sx_north(i,j)**2.)**(0.5)&
			&+Qin(i)*(Sy_north(i,j)**2+Sx_north(i,j)**2)**(0.5)                 
		Fgravs(i,j)=-K_south(i,j)*Sy_south(i,j) 


		!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
		IF (BETA.NE.0) THEN
			Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(T(i,j-1,1)-T(i,j,1))/(abs(yv(i,j)-yv(i,j-1)))&
				&+Sx_south(i,j)*k_eff_south(i,j)*(T(i,j-1,1)-T(i,j,1))/(abs(xv(i,j)-xv(i,j-1)))
			Fcondn(i,j)=Sy_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)&
				&+Sx_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(xv(i,j)-abs(xn(i,j+1)+xn(i+1,j+1))*0.5))
			Fconde(i,j)=0.
			Fcondw(i,j)=0.
		ELSE
			Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(T(i,j-1,1)-T(i,j,1))/(abs(yv(i,j)-yv(i,j-1)))
			Fcondn(i,j)=Sy_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)
			Fconde(i,j)=0.
			Fcondw(i,j)=0.
		ENDIF  

	
		!!!!!!!!!!!!! MIDDLE CELLS !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

		

		!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
		Fpresw(i,2:M-2)=0.                             
		Fprese(i,2:M-2)=0.     
		IF (BETA.NE.0) THEN                          
			Fpress(i,2:M-2)=Sy_south(i,2:M-2)*K_south(i,2:M-2)*(P(i,1:M-3)-P(i,2:M-2))/(abs(yv(i,2:M-2)-yv(i,1:M-3)))&
				&+Sx_south(i,2:M-2)*K_south(i,2:M-2)*(P(i,1:M-3)-P(i,2:M-2))/(abs(xv(i,2:M-2)-xv(i,1:M-3)))      
			Fpresn(i,2:M-2)=Sy_north(i,2:M-2)*K_north(i,2:M-2)*(P(i,3:M-1)-P(i,2:M-2))/(abs(yv(i,2:M-2)-yv(i,3:M-1)))&
				&+Sx_north(i,2:M-2)*K_north(i,2:M-2)*(P(i,3:M-1)-P(i,2:M-2))/(abs(xv(i,2:M-2)-xv(i,3:M-1)))    
		ELSE
			Fpress(i,2:M-2)=Sy_south(i,2:M-2)*K_south(i,2:M-2)*(P(i,1:M-3)-P(i,2:M-2))/(abs(yv(i,2:M-2)-yv(i,1:M-3)))      
			Fpresn(i,2:M-2)=Sy_north(i,2:M-2)*K_north(i,2:M-2)*(P(i,3:M-1)-P(i,2:M-2))/(abs(yv(i,2:M-2)-yv(i,3:M-1)))
		ENDIF		

		!----------- Mass flux due to GRAVITY FORCE --------------------------------
		Fgravw(i,2:M-2)=0.                                  
		Fgrave(i,2:M-2)=-K_east(i,2:M-2)*Sy_east(i,2:M-2)                             
		Fgravn(i,2:M-2)=K_north(i,2:M-2)*Sy_north(i,2:M-2)             
		Fgravs(i,2:M-2)=-K_south(i,2:M-2)*Sy_south(i,2:M-2) 


		!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
		IF (BETA.NE.0) THEN
			Fconds(i,2:M-2)=Sy_south(i,2:M-2)*k_eff_south(i,2:M-2)*(T(i,1:M-3,1)-T(i,2:M-2,1))/(abs(yv(i,2:M-2)-yv(i,1:M-3)))&
				&+Sx_south(i,2:M-2)*k_eff_south(i,2:M-2)*(T(i,1:M-3,1)-T(i,2:M-2,1))/(abs(xv(i,2:M-2)-xv(i,1:M-3)))
			Fcondn(i,2:M-2)=Sy_north(i,2:M-2)*k_eff_north(i,2:M-2)*(T(i,3:M-1,1)-T(i,2:M-2,1))/(abs(yv(i,2:M-2)-yv(i,3:M-1)))&
				&+Sx_north(i,2:M-2)*k_eff_north(i,2:M-2)*(T(i,3:M-1,1)-T(i,2:M-2,1))/(abs(xv(i,2:M-2)-xv(i,3:M-1)))
			Fconde(i,2:M-2)=0.
			Fcondw(i,2:M-2)=0.
		ELSE
			Fconds(i,2:M-2)=Sy_south(i,2:M-2)*k_eff_south(i,2:M-2)*(T(i,1:M-3,1)-T(i,2:M-2,1))/(abs(yv(i,2:M-2)-yv(i,1:M-3)))
			Fcondn(i,2:M-2)=Sy_north(i,2:M-2)*k_eff_north(i,2:M-2)*(T(i,3:M-1,1)-T(i,2:M-2,1))/(abs(yn(i,3:M-1)-yn(i,2:M-2)))
			Fconde(i,2:M-2)=0.
			Fcondw(i,2:M-2)=0.
		ENDIF  


		!!!!!!!!!!!!!!!!!!!!!!!!!!! LOWER CELL !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		j=1		 

		!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
		Fpresw(i,j)=0.                             
		Fprese(i,j)=0.                               
		Fpress(i,j)=0.   
		Fpresn(i,j)=0.   

		!----------- Mass flux due to GRAVITY FORCE --------------------------------
		Fgravw(i,j)=0.                                  
		Fgrave(i,j)=-K_east(i,j)*Sy_east(i,j)                             
		Fgravn(i,j)=K_north(i,j)*Sy_north(i,j)               
		Fgravs(i,j)=-K_south(i,j)*Sy_south(i,j) 


		!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
		IF (BETA.NE.0) THEN
			Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)&
				&+Sx_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(xv(i,j)-(xn(i+1,j)+xn(i,j))*0.5)) 
			Fcondn(i,j)=Sy_north(i,j)*k_eff_north(i,j)*(T(i,j+1,1)-T(i,j,1))/(abs(yv(i,j)-yv(i,j+1)))&
				&+Sx_north(i,j)*k_eff_north(i,j)*(T(i,j+1,1)-T(i,j,1))/(abs(xv(i,j)-xv(i,j+1)))
			Fconde(i,j)=0.
			Fcondw(i,j)=0.
		ELSE
			Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(yv(i,j)*0.5))
			Fcondn(i,j)=Sy_north(i,j)*k_eff_north(i,j)*(T(i,j+1,1)-T(i,j,1))/(abs(yv(i,j)-yv(i,j+1)))
			Fconde(i,j)=0.
			Fcondw(i,j)=0.
		ENDIF  
		

	ELSE !!!!!!!!!!!!! M=2 and N=2
		j=1	
		i=1	 


		!----------- Mass flux due to WATER PRESSURE GRADIENTS --------------------------------
		Fpresw(i,j)=0.                             
		Fprese(i,j)=0.                               
		Fpress(i,j)=0.   
		Fpresn(i,j)=0.   

		!----------- Mass flux due to GRAVITY FORCE --------------------------------
		Fgravw(i,j)=0.                                  
		Fgrave(i,j)=-K_east(i,j)*Sy_east(i,j)                             
		Fgravn(i,j)=rain*(Sy_north(i,j)**2+Sx_north(i,j)**2)**(0.5)&
			&+Qin(i)*(Sy_north(i,j)**2+Sx_north(i,j)**2)**(0.5)                 
		Fgravs(i,j)=-K_south(i,j)*Sy_south(i,j) 



		!!!!!!!!!!!!!!!!!!!!!!! HEAT FLUXES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   
		IF (BETA.NE.0) THEN
			Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)&
				&+Sx_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(xv(i,j)-(xn(i+1,j)+xn(i,j))*0.5)) 
			Fcondn(i,j)=Sy_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)&
				&+Sx_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(xv(i,j)-(xn(i,j+1)+xn(i+1,j+1))*0.5))
			Fconde(i,j)=0.
			Fcondw(i,j)=0.
		ELSE
			Fconds(i,j)=Sy_south(i,j)*k_eff_south(i,j)*(Tground-T(i,j,1))/(abs(yv(i,j)*0.5))
			Fcondn(i,j)=Sy_north(i,j)*k_eff_north(i,j)*(Tss(i)-T(i,j,1))/(abs(yn(i,j+1)-yn(i,j))*0.5)
			Fconde(i,j)=0.
			Fcondw(i,j)=0.
		ENDIF  
		

	ENDIF

ENDIF



RETURN
END